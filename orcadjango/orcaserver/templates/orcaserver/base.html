{% load bootstrap4 %}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/site.css' %}">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

<head>
  <title>Miraculix</title>
  {% if user.is_authenticated %}
  <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
  {% endif %}
  <META NAME="robots" CONTENT="noindex,nofollow">
</head>

<body>
{% bootstrap_messages %}
{% block bootstrap4_content %}
  <div class="navbar-wrapper">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/" title="The miraculous data wizard"><b>MIRACULIX</b></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          {% if user.is_authenticated %}
          <li class="nav-item" style="margin-right: 1.5em;" title="Module settings">
            <a class="nav-link {% if request.path  == '/settings/' %} active {% endif %}" href="{% url 'settings' %}">
            <!--<i class="fa fa-cog"></i>-->
            <i>Modules</i>
            </a>
          </li>
          <li class="nav-item" title="Project selection">
            <a class="nav-link {% if request.path  == '/projects/' %} active {% endif %}" href="{% url 'projects' %}"><i class="fa fa-globe"></i>Project</a>
          </li>
          <div style="padding-top: 0.4em;">></div>
          <li class="nav-item" title="Scenario selection">
            <a class="nav-link {% if request.path  == '/scenarios/' %} active {% endif %}" href="{% url 'scenarios' %}"><i class="fa fa-asterisk"></i>Scenario</a>
          </li>
          <div style="padding-top: 0.4em;">></div>
          <li class="nav-item" title="Parameter overview">
            <a class="nav-link {% if request.path  == '/injectables/' %} active {% endif %}" href="{% url 'injectables' %}"><i class="fa fa-table"></i>Parameters</a>
          </li>
          <div style="padding-top: 0.4em;">></div>
          <li class="nav-item" style="margin-right: 1.5em" title="Configure and run steps">
            <a class="nav-link {% if request.path  == '/steps/' %} active {% endif %}" href="{% url 'steps' %}" ><i style="color: green;" class="fa fa-play-circle"></i>Steps &amp; Run</a>
          </li>
          <div style="padding-top: 0.4em;">&nbsp;</div>
          <li class="nav-item" style="margin-right: 2em" title="Project overview and status">
            <a class="nav-link {% if request.path  == '/status/' %} active {% endif %}" href="{% url 'status' %}"><i class="fa fa-clock-o"></i>Status</a>
          </li>
          {% endif %}
          {% if user.is_superuser %}
          <li class="nav-item">
            <a class="nav-link" href="/admin"><i class="fa fa-grav"></i><i>Admin</i></a>
          </li>
          {% endif %}
        </ul>
        <div style="position: absolute; right: 2em; display: flex;">
        {% if user.is_authenticated %}
          <i class="fa fa-user-o" style="padding-top: 0.3em;"></i>
          logged in as "{{ user.get_username }}" &nbsp;
          <a href="{% url 'logout'%}?next={{request.path}}">logout</a>
          <div title="Display Help texts" style="color: #464646; border: solid #808080 1px; border-radius: 5px; margin-left: 2em; padding: 0px 4px 3px 4px; box-shadow: inset 0 0 2px #808080; background: #f8f9fa; float: right;">
            <i class="fa fa-question-circle" style="vertical-align: middle; font-size: 1.2em;"></i>
            <input id="showHelp" onchange="toggleHelp()" type="checkbox" data-toggle="toggle" data-size="mini">
          </div>
        {% else %}
          <i class="fa fa-user-o" style="padding-top: 0.3em;"></i>
          <a href="{% url 'login'%}?next={{request.path}}">Login</a>
        {% endif %}
        </div>
      </div>
    </nav>
    {% if user.is_authenticated %}
    <div class="row">
      <div class="col-md-8">
          {% if show_project_settings %}
          <div id="project-settings">
            <div>
              Module &nbsp;&nbsp;<a title="Active module" href='/settings'><i>{% if python_module %} {{ python_module }} {% else %} None {% endif %}</i></a>
            </div>
            <div>
              Project &nbsp;&nbsp;&nbsp;<a title="Active project" href='/projects'><h4><i>{% if active_project %} {{ active_project.name }} {% else %} None {% endif %}</i></h4></a>
            </div>
            <div>
              Scenario &nbsp;<a title="Active scenario" href='/scenarios'><h4><i>{% if active_scenario %} {{ active_scenario.name }} {% else %} None {% endif %}</i></h4></a>
            </div>
          </div>
          {% endif %}
      </div>
      <div class="col-md-4">
        {% if show_status %}
        <div id="status-container">
          <label id="status-label" style="float: right; margin-left: 1em;"></label>
          <a href='/status' style="float: right;"> <b> Status:</b> </a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  <div class="row" style="margin-top: 15em;">
    <div class="col-lg-{% if left_columns is not None %}{{ left_columns }}{% else %}2{% endif %}" style="padding-left: 2em;">
    {% block left-content %}
    {% endblock %}
    </div>
    <div class="col-lg-{% if center_columns is not None %}{{ center_columns }}{% else %}7{% endif %}" style="padding-left: 2em;">

      {% autoescape off %}{% bootstrap_messages %}{% endautoescape %}

      {% block content %}{% endblock %}
    </div>
    <div class="col-lg-{% if right_columns is not None %}{{ right_columns }}{% else %}2{% endif %}" style="padding-left: 2em;">
      {% block right-content %}
      {% endblock %}
    </div>
  </div>
{% endblock %}
</body>

<script>
{% if user.is_authenticated %}
var showHelpCheck = document.getElementById('showHelp');
function toggleHelp(){
  var showHelp = showHelpCheck.checked,
      helpContainers = document.querySelectorAll('.help');
  helpContainers.forEach(function(con){
    con.style.visibility = (showHelp) ? 'visible' : 'hidden';
  });
  document.cookie = "showHelp=" + showHelp +"; path=/";
}
if (document.cookie.includes('showHelp')){
  var showHelp = document.cookie.split('; ').find(row => row.startsWith('showHelp=')).split('=')[1];
  $(showHelpCheck).bootstrapToggle((showHelp == "true") ? 'on' : 'off');
}
toggleHelp();
{% endif %}
{% if show_status and active_scenario%}
  var statusUrl = '/status/detail/{{ active_scenario.id }}/',
      statusLabel = document.getElementById('status-label');

  class Status{
    constructor(intervall, on_update) {
      this.on_update = on_update;
      this.intervall = intervall;
    }

    run() {
      var self = this;
      setInterval(function(){self.update()}, this.intervall);
      this.update();
    }

    update() {
      const self = this;
      return new Promise((resolve, reject) => {
        fetch(statusUrl).then(data=>{return data.json()}).then(function(res){
          if (self.on_update) self.on_update(res);
          statusLabel.innerHTML = res.text;
          var color = (res.running) ? 'red' : (res.other_running_in_project.length > 0) ? 'orange' : 'green';
          statusLabel.style.color = color;
          resolve(res)
        }, function(){reject(res)})
      })
    }
  }
  const status = new Status(10000);
  status.run();
{% endif %}
</script>
