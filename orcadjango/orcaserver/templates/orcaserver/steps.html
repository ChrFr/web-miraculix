{% extends 'orcaserver/base.html' %}
{% load static %}

{% block title %}
  {% if request.session.scenario %}
    Steps
  {% else %}
    No scenario selected
  {% endif %}
{% endblock %}

{% block left-content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/site.css' %}">
<div class="col-md-4" style="padding: 2em;">
{% if steps_available %}
  <h6>available</h6>
  <div> <!--style="max-height: 800px; overflow-y: scroll;"-->
    <table class="table select" id="steps-available">
      <thead>
        <tr>
          <th>Group</th>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
      {% for group, steps in steps_available.items %}
        {% for step in steps %}
          <tr onclick="highlightRow(this)" data-step="{{ step.name }}" title="{{ step.name }} - {{ step.description }}">
            <td style="background-color: Snow {% if not forloop.last %} ;border-bottom-style: hidden" {% endif %}"> {% if forloop.first %} <b>{{ group }}</b> {% endif %} </td>
            <td> {{ step.name }} </td>
            <td> {{ step.description }} </td>
          </tr>
        {% endfor %}
      {% endfor %}
      </tbody>
    </table>
  </div>
  <form action='' method="post" style="float: right; margin-top: 10px;">
    {% csrf_token %}
    <input type='hidden' name="steps" id="selected-steps">
    <input class="btn btn-secondary" type="submit" name='add' value="Add >>"/>
  </form>
  <div class="row" id="logPlaceholder" style="height: 30em;"></div>
{% endif %}
</div>
{% endblock %}

{% block content %}
<script src="{% static 'js/jquery-ui.min.js' %}"></script>
{% if error_message %}<p style="color: red;"><strong>{{ error_message }}</strong></p>{% endif %}
{% if steps_available %}
  <h6 style="float: left;">in scenario</h6> &nbsp;&nbsp;(change order by dragging and dropping)
  <table class="table select" id="steps-scenario">
    <thead>
      <tr>
        <th class="index">No.</th>
        <th style="display: none;">ID</th>
        <th>Name</th>
        <th>Injectables</th>
        <th>Started</th>
        <th>Finished</th>
        <th>Success</th>
        <th>Active</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody>
    {% for step in steps_scenario %}
      <tr data-id="{{ step.id }}" title="{{ step.name }} - {{ step.docstring }}" {% if not step.valid %} style="color: red;" {% endif %}>
        <td class="index"> {{ forloop.counter0 }} </td>
        <td style="display: none;"> {{ step.id }} </td>
        <td> {{ step.name }} </td>
        <td class="injectables"> {{ step.injectables }} </td>
        <td class="start"> {{ step.started }} </td>
        <td class="finish"> {{ step.finished }} </td>
        <td class="success" style="text-align: center; vertical-align: middle; color: white;"> </td>
        <td class="is_active">
          <label>
            <input title="Activate/deactivate step" type="checkbox" {% if step.active %} checked {% endif %} id="toggle-active" onclick="toggleActiveRow(this, {{ step.id }})" style="transform: scale(2); margin: 0.5em;">
          </label>
        </td>
        <td>
          <form action='' method="post">
            {% csrf_token %}
            <input type="hidden" name="step" value="{{step.id}}">
            <input title="Remove Step" type="submit" name="remove" class="btn btn-outline-danger" value="X" style="padding: .35rem .6rem; line-height: 1;">
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <button id="run-scenario" type="submit" onclick="runScenario()" class="btn btn-primary" style="float: right;">Run Steps</button>

  <div class="bottom-resizable" style="height: 15em;">
    <div style="width: 100%;">
      <h5 style="float: left; margin-top: 15px;"> Log </h5>
      <!--<button onclick="clearLog()" class="btn btn-secondary" style="margin: 10px; float: right;">Clear</button>-->
      <button onclick="openLogs()" class="btn btn-primary"  style="margin: 10px; float: right;" >History</button>
    </div>
    <div id="wslog" class="log" style="width: 100%; height: calc(100% - 5em); resize: none;"></div>
  </div>

  <div class="modal fade" id="logs-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Log History</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div id="logs-body" class="modal-body" style="overflow-y: auto; max-height: calc(100vh - 200px);">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button onclick="reloadLogs()" type="button" class="btn btn-primary">Reload</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<p>no steps available</p>
{% endif %}

<script>
  function openLogs(){
    $("#logs-modal").modal();
    reloadLogs();
  }

  function reloadLogs(){
    var logsDiv = document.getElementById('logs-body');
    logsDiv.innerHTML = '<h4>Updating...</h4>';
    fetch('/logs').then(function(res){
        return res.text()
    }).then(function(html){
        document.getElementById('logs-body').innerHTML = html;
    });
  }

  var chatSocket = new WebSocket('{{ log_socket }}'),
      logArea = document.querySelector('#wslog');

  chatSocket.onmessage = function(e) {
      var data = JSON.parse(e.data),
          message = data['message'],
          level = data['level'],
          p = document.createElement('p');
      p.innerHTML = message;
      p.style.color = (level == 'ERROR') ? 'red': (level == 'WARNING') ? 'orange': (level == 'DEBUG') ? 'grey' : 'black';
      logArea.appendChild(p);
      logArea.scrollTop = logArea.scrollHeight;
  };

  chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  function clearLog(){ logArea.innerHTML = '' };

  var stepsTable = document.getElementById('steps-scenario'),
      stepsAvailableTable = document.getElementById('steps-available'),
      stepsUrl = '/steps/list/',
      stepUrl = '/steps/',
      stepDetailUrl = '/steps/detail/',
      csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value,
      stepsInput = document.getElementById('selected-steps');

  // highlight row in table on click
  function highlightRow(target){
    target.classList.toggle('selected');
    var inputStr = '';
    for(row of stepsAvailableTable.rows){
      if (row.classList.contains('selected')){
        var step = row.dataset['step'];
        inputStr += step + ',';
      }
    }
    stepsInput.value = inputStr;
  }

  // toggle is_active in row
  function toggleActiveRow(checkbox, stepId){
      var data = {is_active: checkbox.checked};
      fetch(stepDetailUrl+stepId+'/', {
        method: "PATCH",
        body: JSON.stringify(data),
        credentials: "same-origin",
        headers: { "X-CSRFToken": csrfToken }
      });
  }

  function runScenario(){
    updateStatus().then(function(res){
      if (!res.running){
          fetch('/steps/run/', {
              method: "POST",
              credentials: "same-origin",
              headers: { "X-CSRFToken": csrfToken }
            }).then(function(){updateStatus(); updateSteps();});
        }
      else alert('Orca is already running! Abort it or wait.')
    })
  }

  // fetch and update steps in table
  function updateSteps(){
    fetch(stepsUrl).then(data=>{return data.json()}).then(function(res){
      res.forEach(function(step){
        var row = stepsTable.querySelector('tr[data-id="' + step.id + '"]'),
            injCell = row.querySelector('.injectables'),
            startCell = row.querySelector('.start'),
            finishCell = row.querySelector('.finish'),
            successCell = row.querySelector('.success');
        injCell.innerHTML = '';
        startCell.innerHTML = step.started;
        finishCell.innerHTML = step.finished;
        if (step.finished) {
          successCell.innerHTML = step.success;
          successCell.style.background = (step.success) ? 'green' : 'red';
        }
        else {
            successCell.innerHTML = '';
            successCell.style.background = 'white';
        }
        step.injectables.forEach(function(inj){
          var inj_a = document.createElement('a'),
              content = document.createElement('div'),
              url= inj.url + '?next={{request.path}}';
          inj_a.text = inj.name;
          inj_a.href = url;
          if (!inj.valid) {
            inj_a.style.color = 'red';
            inj_a.text += ' (not valid)'
          }
          content.title = inj.value;
          content.innerHTML = '';
          content.prepend(inj_a);
          injCell.appendChild(content);
        });
      })
    })
  }

  //drag and drop of table rows
  function tableDnD(){
    function fixHelperModified(e, tr) {
      var $originals = tr.children();
      var $helper = tr.clone();
      $helper.children().each(function(index) {
          $(this).width($originals.eq(index).width())
      });
      return $helper;
    };
    function updateOrder(e, ui) {
      var data = [],
          rows = stepsTable.querySelectorAll('tbody tr'),
          i = 0;
      rows.forEach(function(row){
        var index = row.querySelector('.index'),
            id = row.dataset['id'];
        index.innerHTML = i;
        i += 1;
        data.push({ id: id, order: i})
      })
      fetch(stepsUrl, {
        method: "POST",
        body: JSON.stringify(data),
        credentials: "same-origin",
        headers: { "X-CSRFToken": csrfToken }
      });
    };

    $("#steps-scenario tbody").sortable({
      helper: fixHelperModified,
      stop: updateOrder
    }).disableSelection();

  }

  (function() {
    // periodically update steps and their progress
    updateSteps();
    setInterval(updateSteps, 10000);
    tableDnD();
  })();
</script>

<script>
  var BORDER_SIZE = 4,
      logDiv = document.querySelector(".bottom-resizable"),
      placeholderDiv = document.getElementById("logPlaceholder");

  let m_pos;
  function resize(e){
    var dy = m_pos - e.y;
    m_pos = e.y;
    logDiv.style.height = (parseInt(getComputedStyle(logDiv, '').height) + dy) + "px";
    placeholderDiv.style.height = (parseInt(getComputedStyle(placeholderDiv, '').height) + dy) + "px";
  }

  logDiv.addEventListener("mousedown", function(e){
    if (e.offsetY < BORDER_SIZE) {
      m_pos = e.y;
      document.addEventListener("mousemove", resize, false);
    }
  }, false);

  document.addEventListener("mouseup", function(){
      document.removeEventListener("mousemove", resize, false);
  }, false);
</script>
{% endblock %}
